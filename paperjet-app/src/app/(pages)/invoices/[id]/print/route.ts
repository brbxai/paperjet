import { getCustomer } from "@/data/customers";
import { getInvoice } from "@/data/invoices";
import { verifySession } from "@/lib/session";
import { actionFailure } from "@/lib/utils";
import { format } from "date-fns";
import { NextResponse } from "next/server";

export async function GET(request: Request, { params }: { params: Promise<{ id: string }> }): Promise<NextResponse> {
  // Verify user is logged in
  const session = await verifySession();
  if (!session) {
    return NextResponse.json(actionFailure("User not logged in"));
  }

  const { id } = await params;

  // Generate PDF
  const invoice = await getInvoice(session.tenantId, id);
  const json = JSON.stringify({
    html, data: {
      ...invoice,
      formattedIssueDate: invoice?.issueDate ? format(invoice!.issueDate, "dd/MM/yyyy") : null,
      formattedDueDate: invoice?.dueDate ? format(invoice!.dueDate, "dd/MM/yyyy") : null,
      customer: invoice?.customerId ? await getCustomer(session.tenantId, invoice.customerId) : null,
    }
  });

  try {
    const response = await fetch("https://tailwind-pdf-generator.fly.dev/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: json,
    });

    if (!response.ok) {
      throw new Error("Failed to generate PDF");
    }

    const pdf = await response.arrayBuffer();
    return new NextResponse(pdf, {
      headers: {
        "Content-Type": "application/pdf",
        "Content-Disposition": `attachment; filename="${invoice!.documentReference}.pdf"`,
      },
    });
  } catch (e) {
    console.error("Error generating PDF", e);
    return NextResponse.json(actionFailure("Error generating PDF"));
  }
}

const html = `
<!DOCTYPE html>
<html>
<head>
    <title>Invoice</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-size: 0.8rem;
        }
        .bg-accent {
            background: black;
        }
    </style>
</head>
<body>
     <div class="flex justify-begin bg-stone-900">
        <div class="container mx-auto p-4 text-white">
          <svg viewBox="0 0 136 31" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-32"><g><path fill-rule="evenodd" clip-rule="evenodd" d="M0.000411987 6.38646C0.000411987 2.90712 2.82098 0.0865479 6.30033 0.0865479H10.1836C12.1081 0.0865479 13.8311 0.949464 14.9866 2.30948C16.1422 0.949464 17.8652 0.0865479 19.7896 0.0865479H23.673C27.1523 0.0865479 29.9729 2.90712 29.9729 6.38646V10.2698C29.9729 12.1944 29.1099 13.9174 27.7498 15.0729C29.1099 16.2285 29.9729 17.9515 29.9729 19.8761V23.7594C29.9729 27.2388 27.1523 30.0593 23.673 30.0593H19.7896C17.865 30.0593 16.142 29.1963 14.9864 27.8361C13.8309 29.1963 12.1078 30.0593 10.1832 30.0593H6.29992C2.82057 30.0593 0 27.2388 0 23.7594V19.8761C0 17.9514 0.863082 16.2283 2.22332 15.0728C0.863319 13.9172 0.000411987 12.1943 0.000411987 10.2698V6.38646ZM13.4898 6.35087C13.4898 6.36273 13.4897 6.37459 13.4897 6.38646V13.5761H6.30033C4.47428 13.5761 2.99397 12.0958 2.99397 10.2698V6.38646C2.99397 4.56041 4.47428 3.0801 6.30033 3.0801H10.1836C11.9978 3.0801 13.4707 4.54121 13.4898 6.35087ZM16.4836 13.5761H23.673C25.499 13.5761 26.9793 12.0958 26.9793 10.2698V6.38646C26.9793 4.56041 25.499 3.0801 23.673 3.0801H19.7896C17.9755 3.0801 16.5026 4.54121 16.4835 6.35087C16.4835 6.36273 16.4836 6.37459 16.4836 6.38646V13.5761ZM2.99356 19.8761C2.99356 18.05 4.47386 16.5697 6.29992 16.5697H13.4896V23.7594C13.4896 25.5855 12.0093 27.0658 10.1832 27.0658H6.29992C4.47386 27.0658 2.99356 25.5855 2.99356 23.7594V19.8761ZM16.4833 23.7594V16.5697H23.673C25.499 16.5697 26.9793 18.05 26.9793 19.8761V23.7594C26.9793 25.5855 25.499 27.0658 23.673 27.0658H19.7896C17.9636 27.0658 16.4833 25.5855 16.4833 23.7594Z" fill="currentColor"></path><path d="M38.0963 6.70414H43.9522C46.0886 6.70414 47.687 7.08069 48.7475 7.83381C49.808 8.57156 50.3383 9.70891 50.3383 11.2459C50.3383 11.9222 50.1923 12.5139 49.9003 13.0211C49.6236 13.5129 49.2086 13.8972 48.6553 14.1738C48.1174 14.4505 47.4642 14.6042 46.6957 14.6349L46.6726 14.5888C48.0713 14.6349 49.1471 14.9961 49.9003 15.6724C50.6534 16.3486 51.0299 17.2708 51.0299 18.4389C51.0299 19.9451 50.4997 21.0979 49.4392 21.8971C48.394 22.6809 46.8724 23.0729 44.8744 23.0729H38.0963V6.70414ZM44.9205 20.5369C45.8734 20.5369 46.6188 20.3371 47.1568 19.9375C47.6947 19.5378 47.9637 18.9692 47.9637 18.2314C47.9637 17.4937 47.6947 16.925 47.1568 16.5254C46.6342 16.1258 45.8888 15.926 44.9205 15.926H41.0934V20.5369H44.9205ZM44.1366 13.5744C45.1356 13.5744 45.9041 13.39 46.4421 13.0211C46.9954 12.6522 47.272 12.122 47.272 11.4303C47.272 10.7079 47.0031 10.1623 46.4651 9.79345C45.9426 9.42457 45.1664 9.24014 44.1366 9.24014H41.0934V13.5744H44.1366ZM56.2244 10.854L56.3397 14.3121L56.1091 14.1969C56.2782 13.0595 56.6087 12.2219 57.1005 11.6839C57.6077 11.1306 58.3224 10.854 59.2446 10.854H60.3742V13.1364H59.2215C58.576 13.1364 58.0457 13.2516 57.6307 13.4822C57.2158 13.6974 56.9084 14.0278 56.7086 14.4735C56.5087 14.9039 56.4088 15.4495 56.4088 16.1104V23.0729H53.4579V10.854H56.2244ZM61.6545 14.5888C61.9004 13.3131 62.4921 12.3294 63.4297 11.6378C64.3826 10.9308 65.6122 10.5773 67.1184 10.5773C68.8706 10.5773 70.2 11.023 71.1068 11.9145C72.029 12.8059 72.4901 14.1123 72.4901 15.8337V20.0297C72.4901 20.3678 72.5516 20.606 72.6746 20.7444C72.8129 20.8673 73.005 20.9288 73.2509 20.9288H73.7351V23.0729L73.0434 23.0959H72.7898C72.0828 23.1267 71.4527 23.0191 70.8994 22.7732C70.346 22.5119 70.0233 21.9893 69.9311 21.2055C69.6237 21.851 69.1165 22.3736 68.4095 22.7732C67.7178 23.1574 66.8648 23.3495 65.8504 23.3495C64.5901 23.3495 63.5373 23.0345 62.6919 22.4043C61.862 21.7741 61.447 20.9288 61.447 19.8683C61.447 19.0998 61.6237 18.4773 61.9772 18.0009C62.3461 17.5244 62.861 17.1555 63.5219 16.8943C64.1828 16.6176 65.0435 16.3717 66.104 16.1565L69.5161 15.4879C69.5161 14.535 69.3163 13.8357 68.9167 13.39C68.5171 12.9289 67.9176 12.6983 67.1184 12.6983C66.4575 12.6983 65.9196 12.8751 65.5046 13.2286C65.0896 13.5667 64.813 14.0739 64.6746 14.7502L61.6545 14.5888ZM64.5132 19.7761C64.5132 20.2218 64.6977 20.583 65.0666 20.8596C65.4354 21.1363 65.9657 21.2746 66.6573 21.2746C67.226 21.2746 67.7255 21.1363 68.1559 20.8596C68.6016 20.583 68.9474 20.1757 69.1933 19.6377C69.4546 19.0844 69.5852 18.4235 69.5852 17.6551V17.4937L67.2567 17.9087C67.1491 17.924 67.0339 17.9394 66.9109 17.9548C66.3576 18.0624 65.9119 18.1776 65.5738 18.3006C65.251 18.4082 64.9897 18.5849 64.7899 18.8308C64.6055 19.0614 64.5132 19.3765 64.5132 19.7761ZM78.5648 10.854V23.0729H75.6138V10.854H78.5648ZM78.634 6.72719V9.17097H75.5677V6.72719H78.634ZM83.7263 10.854L83.8647 14.2891L83.4958 14.1047C83.6649 12.8904 84.1029 11.999 84.8099 11.4303C85.5323 10.8616 86.4237 10.5773 87.4842 10.5773C88.806 10.5773 89.8358 11 90.5735 11.8453C91.3113 12.6753 91.6802 13.7973 91.6802 15.2113V23.0729H88.7061V16.1565C88.7061 15.0806 88.5447 14.2814 88.222 13.7588C87.8992 13.2363 87.3536 12.975 86.5851 12.975C85.7705 12.975 85.1327 13.2516 84.6716 13.8049C84.2259 14.3429 84.003 15.1267 84.003 16.1565V23.0729H81.052V10.854H83.7263ZM94.6908 6.70414H100.547C102.683 6.70414 104.281 7.08069 105.342 7.83381C106.402 8.57156 106.933 9.70891 106.933 11.2459C106.933 11.9222 106.787 12.5139 106.495 13.0211C106.218 13.5129 105.803 13.8972 105.25 14.1738C104.712 14.4505 104.059 14.6042 103.29 14.6349L103.267 14.5888C104.666 14.6349 105.742 14.9961 106.495 15.6724C107.248 16.3486 107.624 17.2708 107.624 18.4389C107.624 19.9451 107.094 21.0979 106.034 21.8971C104.988 22.6809 103.467 23.0729 101.469 23.0729H94.6908V6.70414ZM101.515 20.5369C102.468 20.5369 103.213 20.3371 103.751 19.9375C104.289 19.5378 104.558 18.9692 104.558 18.2314C104.558 17.4937 104.289 16.925 103.751 16.5254C103.229 16.1258 102.483 15.926 101.515 15.926H97.6879V20.5369H101.515ZM100.731 13.5744C101.73 13.5744 102.499 13.39 103.037 13.0211C103.59 12.6522 103.866 12.122 103.866 11.4303C103.866 10.7079 103.598 10.1623 103.06 9.79345C102.537 9.42457 101.761 9.24014 100.731 9.24014H97.6879V13.5744H100.731ZM115.447 23.3495C114.233 23.3495 113.172 23.0882 112.266 22.5657C111.359 22.0431 110.652 21.3054 110.145 20.3524C109.637 19.3841 109.384 18.2545 109.384 16.9634C109.384 15.6724 109.637 14.5504 110.145 13.5975C110.652 12.6292 111.359 11.8837 112.266 11.3612C113.172 10.8386 114.233 10.5773 115.447 10.5773C116.646 10.5773 117.699 10.8386 118.606 11.3612C119.528 11.8837 120.235 12.6292 120.727 13.5975C121.234 14.5504 121.487 15.6724 121.487 16.9634C121.487 18.2545 121.234 19.3841 120.727 20.3524C120.235 21.3054 119.528 22.0431 118.606 22.5657C117.699 23.0882 116.646 23.3495 115.447 23.3495ZM115.447 20.9519C116.4 20.9519 117.138 20.606 117.66 19.9144C118.183 19.2074 118.444 18.2237 118.444 16.9634C118.444 15.7031 118.183 14.7271 117.66 14.0355C117.138 13.3285 116.4 12.975 115.447 12.975C114.494 12.975 113.756 13.3208 113.234 14.0124C112.711 14.7041 112.45 15.6877 112.45 16.9634C112.45 18.2391 112.711 19.2228 113.234 19.9144C113.756 20.606 114.494 20.9519 115.447 20.9519ZM133.91 10.854L129.645 16.8481L134.071 23.0729H130.751L127.916 18.8308L125.057 23.0729H121.737L126.163 16.8481L121.898 10.854H125.218L127.916 14.8655L130.613 10.854H133.91Z" fill="currentColor"></path></g></svg>
        </div>
     </div>
    <div class="container mx-auto bg-white rounded p-8">
        <div class="mb-6">
            <h1 class="font-bold text-xl mb-2">Invoice <span class="text-purple-700 text-lg">{{documentReference}}</span></h1>
            <p class="">
                Date: {{formattedIssueDate}}
                {{#formattedDueDate}}
                    &#x2022; Due Date: {{.}}
                {{/formattedDueDate}}
            </p>
        </div>
        <div class="flex mb-8">
            <div class="w-1/2">
                <h2 class="font-bold text-lg mb-2">Customer Information</h2>
                {{#patient}}
                <p><strong>{{firstName}} {{lastName}}</strong></p>
                <p>{{email}}</p>
                {{/patient}}
            </div>
            <div class="w-1/2">
                <h2 class="font-bold text-lg mb-2">Our Information</h2>
                <p><strong>BRBX BV</strong></p>
                <p>hello@brbx.ai</p>
                <br/>
                <p>Nieuwdorp 5</p>
                <p>3990 Peer</p>
                <p>Belgium</p>
                <br/>
                <p>BTW BE 1012.081.766</p>
            </div>
        </div>
        <div>
            <h2 class="font-bold text-lg mb-2">Items</h2>
            <table class="table-auto w-full mb-6 border-b border-gray-200">
                <thead class="text-left border-b border-gray-300">
                    <tr>
                        <th class="px-4 py-2">Description</th>
                        <th class="px-4 py-2 text-right">Quantity</th>
                        <th class="px-4 py-2 text-right">Price</th>
                        <th class="px-4 py-2 text-right">VAT</th>
                        <th class="px-4 py-2 text-right">Total excl.</th>
                    </tr>
                </thead>
                <tbody>
                {{#lines}}
                    <tr class="border-t border-gray-200">
                        <td class="px-4 py-2">
                            <p class="m-0"><strong>{{description}}</strong></p>
                        </td>
                        <td class="px-4 py-2 text-right">{{quantity}}</td>
                        <td class="px-4 py-2 text-right">€ {{unitPrice}}</td>
                        <td class="px-4 py-2 text-right">€ {{taxAmount}}</td>
                        <td class="px-4 py-2 text-right"><strong>€ {{amountBeforeTax}}</strong></td>
                    </tr>
                {{/lines}}
                </tbody>
            </table>
        </div>
        <div class="mt-5 flex justify-end text-right">
            <table>
                <tbody>
                    <tr><td class="pr-8"><strong>Total excl.</strong></td><td class="p-2 pl-0"> € {{totalAmountBeforeTax}}</td></tr>
                    <tr><td class="pr-8"><strong>VAT</strong></td><td class="p-2 pl-0"> € {{taxAmount}}</td></tr>
                    <tr class="bg-gray-100"><td class="p-2 pr-8"><strong>Total</strong></td><td class="p-2 pl-0"> € {{totalAmountAfterTax}}</td></tr>
                </tbody>
            </table>
        </div>
        <p class="text-right mt-2">KBC BE12 3456 7890 1234</p>
        <p class="text-right italic mt-2">Payable within 30 days.</p>
    </div>
</body>
</html>
`;